FROM node:20-alpine

ENV NODE_ENV=development

WORKDIR /app

RUN apk add --no-cache curl

# Copy root package files
COPY package.json package-lock.json ./

# Copy service package files
COPY backend/shared/package.json backend/shared/
COPY backend/services/ai/package.json backend/services/ai/

# Install dependencies from root
RUN npm install

# Copy shared source code and build
COPY backend/shared backend/shared
RUN npm run build -w backend/shared

# Copy service source code
COPY backend/services/ai backend/services/ai

EXPOSE 3002
EXPOSE 51204

# Run the service
CMD ["npm", "run", "start:dev", "-w", "backend/services/ai"]
